# web.damoang.net → Angple (블루-그린)
# 사용법: 이 내용으로 damoang.conf의 web.damoang.net 서버 블록을 교체
#
# 필수: /etc/nginx/conf.d/angple-upstream.conf 에 upstream 설정 필요
#   upstream angple_backend { server 127.0.0.1:3010; }
#   (deploy-bg.sh가 자동 관리)

server {
    listen 80;
    server_name web.damoang.net;

    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    access_log /var/log/nginx/web_damoang_access.log;
    error_log /var/log/nginx/web_damoang_error.log warn;

    # 헬스체크
    location = /healthz {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Go Backend API v2
    location /api/v2/ {
        proxy_pass http://127.0.0.1:8090/api/v2/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # Go Backend API v1
    location /api/v1/ {
        proxy_pass http://127.0.0.1:8090/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # Go Backend API - plugins
    location /api/plugins/ {
        proxy_pass http://127.0.0.1:8090/api/plugins/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # SvelteKit (블루-그린 upstream)
    location / {
        proxy_pass http://angple_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
