# WebSocket Connection 헤더 조건부 설정
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# (쿠키 인증 해제됨)

# Admin 서브도메인
server {
    listen 80;
    server_name admin.damoang.net;

    access_log /var/log/nginx/admin_damoang_access.log;
    error_log /var/log/nginx/admin_damoang_error.log warn;


    location / {
        proxy_pass http://127.0.0.1:3030/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        # WebSocket support for dev server
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location = /healthz {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}

# Web 서브도메인 (제한적 공개 - 읽기 전용)
server {
    listen 80;
    server_name web.damoang.net;

    # 실제 클라이언트 IP 복원 (ALB 뒤)
    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    access_log /var/log/nginx/web_damoang_access.log;
    error_log /var/log/nginx/web_damoang_error.log warn;

    # === 허용 경로 ===

    # /free → SvelteKit
    location /free {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # /my, /my/*
    location /my {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # /login, /login/*
    location /login {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # /giving, /giving/*
    location /giving {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # /trade, /trade/*
    location /trade {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # SvelteKit API (ads 배너 등) - Go 백엔드보다 먼저 매칭
    location /api/ads/ {
        proxy_pass http://angple_web/api/ads/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # Go Backend API - 모든 /api/ 경로를 프록시
    location /api/ {
        proxy_pass http://127.0.0.1:8084/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # 정적 자산 (_app, favicon, images, emoticons, themes 등)
    location ~ ^/(_app|favicon\.ico|robots\.txt|images|emoticons|themes) {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /data/ 정적 파일 (회원 이미지, 에디터 파일 등)
    location /data/ {
        alias /home/damoang/www/data/;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # healthz
    location = /healthz {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # === 기본 경로 → SvelteKit ===
    location / {
        proxy_pass http://angple_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}

# Komodo 서브도메인
server {
    listen 80;
    server_name komodo.damoang.net;
    access_log /var/log/nginx/komodo_damoang_access.log;
    error_log /var/log/nginx/komodo_damoang_error.log warn;

    location / {
        proxy_pass http://127.0.0.1:9120/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location = /healthz {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}

# Dev(스테이징) 서브도메인 - Docker 컨테이너 (포트 3030)
server {
    listen 80;
    server_name dev.damoang.net;

    # 실제 클라이언트 IP 복원 (ALB 뒤)
    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # 접근 제한 (web.damoang.net과 동일)
    allow 116.125.107.11;
    allow 222.114.40.216;
    allow 121.138.24.16;
    allow 127.0.0.1;
    deny all;

    access_log /var/log/nginx/dev_damoang_access.log;
    error_log /var/log/nginx/dev_damoang_error.log warn;

    # Go Backend API v2
    location /api/v2/ {
        proxy_pass http://127.0.0.1:8082/api/v2/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # Go Backend API v1
    location /api/v1/ {
        proxy_pass http://127.0.0.1:8082/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # Go Backend API - plugins (배너, 프로모션)
    location /api/plugins/ {
        proxy_pass http://127.0.0.1:8082/api/plugins/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }

    # JSON 데이터 서빙 (레거시)
    location /data/cache/recommended/ {
        alias /home/damoang/www/data/cache/recommended/;
        add_header Access-Control-Allow-Origin *;
        add_header Content-Type application/json;
        add_header Cache-Control "public, max-age=300, must-revalidate";
        etag on;
    }

    # SvelteKit Dev (포트 3030 - Docker 컨테이너)
    location / {
        proxy_pass http://127.0.0.1:3030/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # WebSocket support
        proxy_http_version 1.1;
        # nosemgrep: generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location = /healthz {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
