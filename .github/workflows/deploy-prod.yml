name: Deploy to Prod (EC2)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: commit SHA)'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Set image tag
        id: set-tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=main-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            IMAGE_TAG="${{ steps.set-tag.outputs.tag }}"
            ECR_REGISTRY="891376997084.dkr.ecr.ap-northeast-2.amazonaws.com"
            REPOSITORY="damoang"

            echo "ğŸš€ Deploying angple with image tag: $IMAGE_TAG"

            cd /home/damoang/angple
            git fetch origin
            git checkout main
            git pull origin main

            # ECR ë¡œê·¸ì¸
            echo "ğŸ”‘ Logging into ECR..."
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY

            # EC2ì—ì„œ ë¹Œë“œ & ECR push
            echo "ğŸ”¨ Building images on EC2..."
            docker build -f apps/web/Dockerfile --target production -t $ECR_REGISTRY/$REPOSITORY:web-$IMAGE_TAG -t $ECR_REGISTRY/$REPOSITORY:web-latest .
            docker build -f apps/admin/Dockerfile --target production -t $ECR_REGISTRY/$REPOSITORY:admin-$IMAGE_TAG -t $ECR_REGISTRY/$REPOSITORY:admin-latest .

            echo "ğŸ“¤ Pushing to ECR..."
            docker push $ECR_REGISTRY/$REPOSITORY:web-$IMAGE_TAG
            docker push $ECR_REGISTRY/$REPOSITORY:web-latest
            docker push $ECR_REGISTRY/$REPOSITORY:admin-$IMAGE_TAG
            docker push $ECR_REGISTRY/$REPOSITORY:admin-latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ Stopping existing containers..."
            docker stop angple-web angple-admin 2>/dev/null || true
            docker rm angple-web angple-admin 2>/dev/null || true

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸŸ¢ Starting containers..."
            docker run -d \
              --name angple-web \
              -p 3010:3000 \
              --restart unless-stopped \
              --memory="2g" \
              --cpus="1.0" \
              -e NODE_ENV=production \
              -e API_BASE_URL=http://angple-gateway:8080 \
              -e PUBLIC_API_BASE_URL=https://api.damoang.net \
              $ECR_REGISTRY/$REPOSITORY:web-$IMAGE_TAG

            docker run -d \
              --name angple-admin \
              -p 3011:80 \
              --restart unless-stopped \
              --memory="1g" \
              --cpus="0.5" \
              $ECR_REGISTRY/$REPOSITORY:admin-$IMAGE_TAG

            # ë„¤íŠ¸ì›Œí¬ ì—°ê²°
            docker network connect angple-network angple-web 2>/dev/null || true
            docker network connect angple-network angple-admin 2>/dev/null || true
            docker network connect proxy-network angple-web 2>/dev/null || true
            docker network connect proxy-network angple-admin 2>/dev/null || true

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ Health check..."
            sleep 10
            docker ps | grep -E "angple-(web|admin)"

            # ì •ë¦¬
            docker image prune -f

            echo "âœ… Deployed at $(date)"
            echo "ğŸ“ Tag: $IMAGE_TAG"
