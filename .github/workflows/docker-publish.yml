name: Docker Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: '배포 환경'
        required: true
        default: 'build-only'
        type: choice
        options:
          - build-only
          - prod
      confirm:
        description: '프로덕션 배포 확인 (prod 선택 시 "deploy" 입력)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/angple-web

jobs:
  # main push 시 Docker 이미지 빌드 + GHCR push
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout angple
        uses: actions/checkout@v4

      - name: Checkout angple-premium
        uses: actions/checkout@v4
        with:
          repository: angple/angple-premium
          token: ${{ secrets.PREMIUM_REPO_TOKEN }}
          path: _premium
        continue-on-error: true

      - name: Install premium assets
        if: hashFiles('_premium/deploy/install.sh') != ''
        run: |
          chmod +x _premium/deploy/install.sh
          _premium/deploy/install.sh .
          echo "Premium assets installed"

      - name: Ensure premium directories exist
        run: |
          mkdir -p custom-themes custom-widgets extensions plugins widgets

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/Dockerfile
          target: production
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=production
          cache-to: type=gha,mode=max,scope=production
          build-args: |
            VITE_USE_MOCK=false
            VITE_GAM_NETWORK_CODE=23338387889
            VITE_GAM_SITE_NAME=damoang

      - name: Image digest
        run: echo "Image pushed with tags ${{ steps.meta.outputs.tags }}"

  # 프로덕션 배포 (수동 트리거 전용)
  deploy-prod:
    name: Deploy to Production
    needs: build-and-push
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch'
      && github.event.inputs.environment == 'prod'
      && github.event.inputs.confirm == 'deploy'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            set -e

            echo "=== Production Deploy Start ==="

            # GHCR 로그인
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 최신 이미지 pull
            docker pull ${{ env.IMAGE_NAME }}:latest

            # 기존 컨테이너 강제 제거
            docker rm -f angple-web 2>/dev/null || true
            sleep 3

            # 환경 변수 파일 확인
            ENV_FILE="/home/damoang/angple-deploy/.env.prod"
            ENV_FLAG=""
            if [ -f "$ENV_FILE" ]; then
              ENV_FLAG="--env-file $ENV_FILE"
            fi

            # 새 컨테이너 시작 (host 네트워크 — 포트 바인딩 충돌 방지)
            docker run -d \
              --name angple-web \
              --restart unless-stopped \
              --network host \
              -v /home/damoang/angple-deploy/data-prod:/app/data \
              -e NODE_ENV=production \
              -e PORT=3010 \
              $ENV_FLAG \
              ${{ env.IMAGE_NAME }}:latest

            # 헬스체크 대기
            echo "Waiting for health check..."
            for i in $(seq 1 30); do
              if docker exec angple-web wget -q -O /dev/null http://127.0.0.1:3010/health 2>/dev/null; then
                echo "Health check passed!"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "Health check failed after 30 attempts"
                docker logs --tail 50 angple-web
                exit 1
              fi
              sleep 2
            done

            # 이전 이미지 정리
            docker image prune -f

            echo "=== Production Deploy Complete ==="
