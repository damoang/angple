name: Deploy Web to AWS

on:
    push:
        branches:
            - main
        paths:
            - 'apps/web/**'
            - '.github/workflows/deploy-web.yml'
            - 'scripts/deploy-web.py'
    workflow_dispatch:

env:
    AWS_REGION: ap-northeast-2
    ECR_REPOSITORY: angple-web

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        environment: production
        permissions:
            contents: read
            packages: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v5
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to AWS ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push to ECR
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  cd apps/web

                  # 이미지 빌드 및 푸시
                  docker buildx build \
                    --platform linux/amd64 \
                    --push \
                    -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
                    -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest \
                    .

                  # Manifest digest 가져오기
                  DIGEST=$(docker buildx imagetools inspect --format='{{ json .Manifest.Digest }}' $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest)
                  echo "ECR_MANIFEST_DIGEST=$DIGEST" >> $GITHUB_ENV
                  echo "ECR_REGISTRY_HOST=$ECR_REGISTRY" >> $GITHUB_ENV
                  echo "ECR_IMAGE_NAME=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest" >> $GITHUB_ENV

            - name: Install uv
              uses: astral-sh/setup-uv@v6

            - name: Deploy to AWS EC2 with boto3
              id: deploy-aws
              env:
                  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
                  APP_DIR: ${{ vars.APP_DIR || '/app' }}
                  DEPLOY_DIRNAME: ${{ vars.DEPLOY_DIRNAME || 'angple' }}
                  CONTAINER_NAME: ${{ vars.CONTAINER_NAME || 'angple-web' }}
                  CONTAINER_PORT: ${{ vars.CONTAINER_PORT || '3000' }}
              run: uv run scripts/deploy-web.py

            - name: Send deploy result to Discord
              if: always() && secrets.DISCORD_WEBHOOK != ''
              env:
                  EMBED_TITLE: ${{ steps.deploy-aws.conclusion == 'success' && 'Deploy success image digest' || 'Deploy failed image digest' }}
                  EMBED_COLOR: ${{ steps.deploy-aws.conclusion == 'success' && 8900331 || 16711680 }}
              uses: tsickert/discord-webhook@v7.0.0
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
                  content: "Angple Web deploy result"
                  embed-title: "${{ env.EMBED_TITLE }}"
                  embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  embed-description: "**${{ env.ECR_MANIFEST_DIGEST }}**"
                  embed-color: ${{ env.EMBED_COLOR }}

            - name: Cleanup old ECR images
              if: success()
              run: |
                  # 최신 5개 이미지만 유지
                  aws ecr describe-images \
                    --repository-name ${{ env.ECR_REPOSITORY }} \
                    --query 'sort_by(imageDetails,& imagePushedAt)[:-5].[imageDigest]' \
                    --output text | \
                  while read digest; do
                    aws ecr batch-delete-image \
                      --repository-name ${{ env.ECR_REPOSITORY }} \
                      --image-ids imageDigest=$digest || true
                  done
