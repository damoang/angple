# =============================================================================
# damoang.net SvelteKit 첫 페이지 전환 nginx 설정
# =============================================================================
#
# 사용법:
#   1. 이 파일의 내용을 /etc/nginx/conf.d/damoang.net.conf에 추가
#   2. nginx -t && sudo nginx -s reload
#
# 롤백:
#   아래 3개 location 블록을 주석 처리하고 nginx -s reload (약 1초)
#
# 주의:
#   - angple_backend upstream이 /etc/nginx/conf.d/angple-upstream.conf에 정의되어 있어야 함
#   - 현재: upstream angple_backend { server 127.0.0.1:3012; }
# =============================================================================

# --- 아래 블록들을 damoang.net.conf의 "location /" 블록 앞에 추가 ---

    # [SvelteKit] 메인 페이지만 SvelteKit으로 서빙 (정확 매칭)
    location = / {
        proxy_pass http://angple_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;

        # SvelteKit 응답 헤더(CSP 등)가 크므로 버퍼 확대
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # [SvelteKit] 정적 파일 (JS/CSS - immutable 캐시)
    location /_app/ {
        proxy_pass http://angple_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # immutable 파일은 1년 캐시
        proxy_cache_valid 200 1y;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # [SvelteKit] 테마 에셋
    location /themes/ {
        proxy_pass http://angple_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

# --- API 캐시 설정 (선택사항, 권장) ---
# /etc/nginx/conf.d/api-cache.conf 또는 nginx.conf의 http 블록에 추가:
#
# proxy_cache_path /tmp/nginx_api_cache levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=2m;
#
# 그 후 damoang.net.conf의 location 블록에서 사용:
#
#     location /api/v1/boards/ {
#         proxy_pass http://127.0.0.1:8090;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Cookie $http_cookie;
#
#         # 30초 API 응답 캐시
#         proxy_cache api_cache;
#         proxy_cache_valid 200 30s;
#         proxy_cache_key $uri$is_args$args;
#         add_header X-Cache-Status $upstream_cache_status always;
#     }
